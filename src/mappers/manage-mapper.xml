<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="manageMapper">

	<resultMap id="manageResultSet" type="Manage" >
		
		<id property="idx" column="IDX"/>
		<result property="yyyy" column="YYYY"/>
		<result property="mm" column="MM"/>
		<result property="wdt" column="WDT"/>
		<result property="edt" column="EDT"/>
		<result property="uId" column="U_ID"/>
		<result property="gasM" column="GAS_M"/>
		<result property="elM" column="EL_M"/>
		<result property="wtM" column="WT_M"/>
		<result property="itM" column="IT_M"/>
		
		<result property="gNum" column="G_NUM"/>
		<result property="pNum" column="P_NUM"/>
		<result property="defM" column="DEF_M"/>
		<result property="cGm" column="C_GM"/>
		<result property="uGm" column="U_GM"/>
		<result property="aGm" column="A_GM"/>
		<result property="sGm" column="S_GM"/>
		<result property="kGm" column="K_GM"/>
		<result property="mGm" column="M_GM"/>
		<result property="avgGm" column="AVG_GM"/>
		<result property="jsGm" column="JS_GM"/>
		<result property="enGu" column="EN_GU"/>
		<result property="monGu" column="MON_GU"/>
		<result property="useG" column="USE_G"/>
		<result property="useB" column="USE_B"/>
		<result property="gChk" column="G_CHK"/>
		<result property="autoM" column="AUTO_M"/>
		<result property="autoHow" column="AUTO_HOW"/>
		<result property="autoWhen" column="AUTO_WHEN"/>
		
	</resultMap>



	<!--기본 공과금 데이터 시작 -->

	<!-- 공과금 전체 페이지 당월 데이터 -->
	<select id="manageList" parameterType="Manage" resultMap="manageResultSet">
		SELECT IDX, YYYY,MM,U_ID, GAS_M, EL_M, WT_M, IT_M
		FROM MANAGE_MA WHERE U_ID= #{uId} AND YYYY =#{yyyy} AND MM = #{mm}	
	</select>

	<!-- 공과금 전체 페이지 당월,전월 비교 데이터 -->
	<select id="manageNP" parameterType="Manage" resultMap="manageResultSet">
		SELECT IDX, YYYY,MM,U_ID, NVL(GAS_M,0) as GAS_M, NVL(EL_M,0) AS EL_M , NVL(WT_M,0) AS WT_M, NVL(IT_M,0) AS IT_M
		FROM MANAGE_MA WHERE U_ID= #{uId} AND (YYYY =#{yyyy} AND MM = #{mm} or YYYY =#{yyyy2} AND MM = #{mm2}) 	
	</select>
	
	<!-- 공과금 전체 페이지 3개월 비교 데이터 -->
	<select id="manageListP3" parameterType="Manage" resultMap="manageResultSet">
		SELECT IDX, YYYY,MM,U_ID, NVL(GAS_M,0) as GAS_M, NVL(EL_M,0) AS EL_M , NVL(WT_M,0) AS WT_M, NVL(IT_M,0) AS IT_M
		FROM MANAGE_MA WHERE U_ID= #{uId} AND (YYYY =#{yyyy} AND MM = #{mm} or YYYY =#{yyyy2} AND MM = #{mm2} or YYYY =#{yyyy3} AND MM = #{mm3})
		   ORDER BY YYYY DESC, MM DESC 	
	</select>
	
	<!-- 공과금 데이터 insert(당월) -->
	<insert id="insertMAll" parameterType="Manage">
		INSERT INTO MANAGE_MA(YYYY, MM, WDT,EDT, U_ID, GAS_M, EL_M, WT_M, IT_M) VALUES(#{yyyy}, #{mm}, #{gChk}, NOW(), #{uId}, 
		#{gasM},#{elM},#{wtM},#{itM})
	</insert>

	<!-- 공과금 데이터 update (기본값만) -->
	<update id="updateMAll" parameterType="Manage">
		UPDATE MANAGE_MA SET EDT=NOW(), GAS_M=#{gasM}, EL_M=#{elM}, WT_M=#{wtM}, IT_M=#{itM}
		WHERE U_ID=#{uId} AND YYYY=#{yyyy} AND MM=#{mm}
	</update>
	
	<!-- 공과금 가스 상세 데이터 insert(당월) -->
	<insert id="insertMGAS" parameterType="Manage">
		INSERT INTO MANAGE_GAS(JIDX,U_ID,AUTO_HOW,AUTO_WHEN,AUTO_M,G_NUM, P_NUM,WDT) VALUES (#{jidx}, #{uId},
		( select A.AUTO_HOW From MANAGE_GAS A
        left join MANAGE_MA B on A.JIDX=B.IDX
        where B.YYYY=#{yyyy} and B.MM=${mm}-1 AND B.U_ID=#{uId}),
        ( select A.AUTO_WHEN From MANAGE_GAS A
        left join MANAGE_MA B on A.JIDX=B.IDX
        where B.YYYY=#{yyyy} and B.MM=${mm}-1 AND B.U_ID=#{uId})
        ,( select A.AUTO_M From MANAGE_GAS A
        left join MANAGE_MA B on A.JIDX=B.IDX
        where B.YYYY=#{yyyy} and B.MM=${mm}-1 AND B.U_ID=#{uId})
        ,( select A.G_NUM From MANAGE_GAS A
        left join MANAGE_MA B on A.JIDX=B.IDX
        where B.YYYY=#{yyyy} and B.MM=${mm}-1 AND B.U_ID=#{uId})
        ,( select A.P_NUM From MANAGE_GAS A
        left join MANAGE_MA B on A.JIDX=B.IDX
        where B.YYYY=#{yyyy} and B.MM=${mm}-1 AND B.U_ID=#{uId}
        ),#{gChk}
		)
	</insert>
	
	<!-- 공과금 상세(가스,수도...) 데이터 가져올 때 필요한 기본 공과금 데이터 IDX -->
	<select id="manageIndex" parameterType="Manage" resultType="_int">
			SELECT IDX
		FROM MANAGE_MA WHERE U_ID= #{uId} AND YYYY =#{yyyy} AND MM = #{mm}	
	</select>
	
	<!--  가스  데이터 update -->
	<update id="updateTgasM" parameterType="Manage">
		UPDATE MANAGE_MA SET GAS_M=#{gasM}
		WHERE IDX=#{idx}
	</update>
	
	<!--기본 공과금 데이터 종료 -->
	
	
	<!--가스 상세 데이터 시작 -->
	
	<!-- 가스 상세 데이터 가져오기 (당월분 1) -->
	<select id="manageGasNow" parameterType="Manage" resultMap="manageResultSet">
		SELECT * FROM MANAGE_GAS A
		LEFT JOIN MANAGE_MA B ON A.JIDX=B.IDX
		WHERE A.U_ID=#{uId} AND B.YYYY=#{yyyy} AND B.MM=#{mm}  	
	</select>
	
	
	<!-- 공과금 데이터 update (기본값만) -->
	<update id="updateGas" parameterType="Manage">
		UPDATE MANAGE_GAS SET EDT=NOW(), DEF_M=#{defM}, C_GM=#{cGm}, U_GM=#{uGm}, A_GM=#{aGm}
		, S_GM=#{sGm},K_GM=#{kGm}, M_GM=#{mGm}, AVG_GM=#{avgGm}, JS_GM=#{jsGm}, EN_GU=#{enGu}, MON_GU=#{monGu}
		, USE_G=#{useG}, USE_B=#{useB}
		WHERE U_ID=#{uId} AND IDX=#{idx}
	</update>
	
	<!-- 공과금 기본 가스 데이터 update (개발멈춤)--> 
	<update id="updateMGas" parameterType="Manage">
		UPDATE MANAGE_MA SET GAS_M=${defM} + ${cGm} +${uGm} +${aGm} +${sGm} +${mGm} + ${avgGm} +  ${jsGm} +${enGu}
		WHERE U_ID=#{uId} AND IDX=#{jidx}
	</update>
	
	<!--  가스 지출 여부 데이터 update -->
	<update id="updateGchk" parameterType="Manage">
		UPDATE MANAGE_GAS SET G_CHK=#{gChk}
		WHERE IDX=#{idx}
	</update>
	<!--  가스 납부 여부 체크 확인 update -->
	<update id="updateGchkA" parameterType="Manage">
		UPDATE MANAGE_GAS SET AUTO_M=#{autoM}
		WHERE IDX=#{idx}
	</update>
	
	<!--  가스 계량기 번호 데이터 update -->
	<update id="updateGasNum" parameterType="Manage">
		UPDATE MANAGE_GAS SET G_NUM=#{gNum}
		WHERE IDX=#{idx}
	</update>
	
	<!--  가스 고객 번호 데이터 update -->
	<update id="updatepNum" parameterType="Manage">
		UPDATE MANAGE_GAS SET P_NUM=#{pNum}
		WHERE IDX=#{idx}
	</update>
	
	<!--  가스 전체 데이터 update -->
	<update id="allUpdateGas" parameterType="Manage">
		UPDATE MANAGE_GAS SET 
		EDT=NOW(), DEF_M=#{defM}, C_GM=#{cGm}, U_GM=#{uGm}, A_GM=#{aGm}
		, S_GM=#{sGm},K_GM=#{kGm}, M_GM=#{mGm}, AVG_GM=#{avgGm}, 
		JS_GM=#{jsGm}, EN_GU=#{enGu}, MON_GU=#{monGu}
		, USE_G=#{useG}, USE_B=#{useB},
		 P_NUM=#{pNum}, G_NUM=#{gNum}, G_CHK=#{gChk},AUTO_M=#{autoM}
		 ,AUTO_HOW=#{autoHow}, AUTO_WHEN=#{autoWhen}
		WHERE U_ID=#{uId} AND IDX=#{idx}
	</update>
	
	
	<!--가스 당월,전월 비교 데이터 -->
	<select id="gasNP" parameterType="Manage" resultMap="manageResultSet">
		 SELECT A.IDX, B.YYYY,B.MM,B.U_ID, 
        SUM(DEF_M + C_GM + U_GM + A_GM + S_GM + M_GM + K_GM + AVG_GM - JS_GM + EN_GU) AS SUMA,
        U_GM,MON_GU, USE_G
		FROM MANAGE_GAS A
        LEFT JOIN MANAGE_MA B ON A.JIDX=B.IDX
        WHERE A.U_ID= #{uId} AND (B.YYYY =#{yyyy} AND B.MM = #{mm} or B.YYYY =#{yyyy2} AND B.MM = #{mm2})
        GROUP BY  A.IDX, B.YYYY,B.MM,B.U_ID,U_GM,MON_GU, USE_G 	
	</select>
	
	<!--가스 6개월치 비교 데이터 -->
	<select id="gasNP6m" parameterType="Manage" resultMap="manageResultSet">
		 SELECT A.IDX, B.YYYY,B.MM,B.U_ID, 
        SUM(DEF_M + C_GM + U_GM + A_GM + S_GM + M_GM + K_GM + AVG_GM - JS_GM + EN_GU) AS SUMA
		FROM MANAGE_GAS A
        LEFT JOIN MANAGE_MA B ON A.JIDX=B.IDX
        WHERE  A.U_ID= #{uId} AND TO_CHAR(B.WDT, 'YYYY/MM') BETWEEN #{yyyy2} AND #{yyyy}
        GROUP BY  A.IDX, B.YYYY,B.MM,B.U_ID,B.WDT
        ORDER BY B.YYYY,B.MM 
	</select>
	
	<!--가스 상세 데이터 종료-->
</mapper>
